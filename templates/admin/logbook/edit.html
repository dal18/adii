{% extends "admin/layout.html" %}

{% block title %}Edit Entry #{{ entry['id'] }} - Logbook System{% endblock %}
{% block nav_page_title %}Edit Entry{% endblock %}
{% block page_title %}Edit Entry #{{ entry['id'] }}{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('admin_logbook_index') }}">Logbook</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('admin_logbook_show', id=entry['id']) }}">Entry #{{ entry['id'] }}</a></li>
    <li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Edit Logbook Entry</h3>
    </div>
    <div class="card-body">
        <form method="POST" id="entry-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="date">Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date" name="date" value="{{ entry['date'] }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="time">Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="time" name="time" value="{{ entry['time'] }}" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="name">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ entry['name'] }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="gender">Gender <span class="text-danger">*</span></label>
                        <select class="form-control" id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male" {{ 'selected' if entry['gender'] == 'Male' else '' }}>Male</option>
                            <option value="Female" {{ 'selected' if entry['gender'] == 'Female' else '' }}>Female</option>
                            <option value="Other" {{ 'selected' if entry['gender'] == 'Other' else '' }}>Other</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="age">Age <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="age" name="age" min="1" max="150" value="{{ entry['age'] }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="purpose">Purpose of Visit <span class="text-danger">*</span></label>
                        {% set purpose_options = ['Meeting', 'Inquiry', 'Delivery', 'Maintenance', 'Inspection', 'Interview', 'Official Business'] %}
                        {% set is_custom_purpose = entry['purpose'] not in purpose_options %}
                        <select class="form-control" id="purpose" name="purpose" required onchange="handlePurposeChange()">
                            <option value="">Select Purpose</option>
                            {% for opt in purpose_options %}
                            <option value="{{ opt }}" {{ 'selected' if entry['purpose'] == opt else '' }}>{{ opt }}</option>
                            {% endfor %}
                            <option value="Others" {{ 'selected' if is_custom_purpose else '' }}>Others</option>
                        </select>
                        <input type="text" class="form-control mt-2" id="custom_purpose" name="custom_purpose" placeholder="Please specify your purpose" value="{{ entry['purpose'] if is_custom_purpose else '' }}" style="{{ 'display: block;' if is_custom_purpose else 'display: none;' }}">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="position">Position/Title <span class="text-danger">*</span></label>
                        {% set position_options = ['Student', 'Teacher', 'Staff', 'Visitor', 'Parent', 'Administrator', 'Manager'] %}
                        {% set is_custom_position = entry['position'] not in position_options %}
                        <select class="form-control" id="position" name="position" required onchange="handlePositionChange()">
                            <option value="">Select Position</option>
                            {% for opt in position_options %}
                            <option value="{{ opt }}" {{ 'selected' if entry['position'] == opt else '' }}>{{ opt }}</option>
                            {% endfor %}
                            <option value="None" {{ 'selected' if is_custom_position else '' }}>None</option>
                        </select>
                        <input type="text" class="form-control mt-2" id="custom_position" name="custom_position" placeholder="Please specify your position" value="{{ entry['position'] if is_custom_position else '' }}" style="{{ 'display: block;' if is_custom_position else 'display: none;' }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="contact_number">Contact Number <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="contact_number" name="contact_number" value="{{ entry['contact_number'] }}" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" id="address" name="address" value="{{ entry.get('address', '') }}" placeholder="Enter address">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="office">Office</label>
                        {% set office_options = ['Administration', 'IT Department', 'HR Department', 'Finance', 'Operations', 'Marketing', 'Sales'] %}
                        {% set office_value = entry.get('office', '') %}
                        {% set is_custom_office = office_value and office_value not in office_options %}
                        <select class="form-control" id="office" name="office" onchange="handleOfficeChange()">
                            <option value="">Select Office</option>
                            {% for opt in office_options %}
                            <option value="{{ opt }}" {{ 'selected' if office_value == opt else '' }}>{{ opt }}</option>
                            {% endfor %}
                            <option value="None" {{ 'selected' if is_custom_office else '' }}>None</option>
                        </select>
                        <input type="text" class="form-control mt-2" id="custom_office" name="custom_office" placeholder="Please specify office name" value="{{ office_value if is_custom_office else '' }}" style="{{ 'display: block;' if is_custom_office else 'display: none;' }}">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Electronic Signature <span class="text-danger">*</span></label>
                <canvas id="signature-pad" width="600" height="130"></canvas>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-secondary" id="clear-signature">
                        <i class="fas fa-eraser mr-1"></i> Clear Signature
                    </button>
                    {% if entry['signature'] %}
                    <button type="button" class="btn btn-sm btn-info" id="load-signature">
                        <i class="fas fa-redo mr-1"></i> Load Previous Signature
                    </button>
                    {% endif %}
                    <small class="text-muted ml-2">Sign above using your mouse or touch screen</small>
                </div>
                {% if entry['signature'] %}
                <div class="mt-2">
                    <small class="text-muted">Current signature:</small><br>
                    <img src="{{ entry['signature'] }}" alt="Current signature" style="max-width: 300px; border: 1px solid #dee2e6; border-radius: 5px; padding: 5px; background: #f8f9fa;">
                </div>
                {% endif %}
                <input type="hidden" id="signature" name="signature" value="{{ entry['signature'] }}" required>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save mr-1"></i> Save Changes
                </button>
                <a href="{{ url_for('admin_logbook_show', id=entry['id']) }}" class="btn btn-secondary ml-2">
                    <i class="fas fa-times mr-1"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script>
    // Position change handler
    function handlePositionChange() {
        const positionSelect = document.getElementById('position');
        const customPositionInput = document.getElementById('custom_position');
        
        if (positionSelect.value === 'None') {
            customPositionInput.style.display = 'block';
            customPositionInput.required = true;
        } else {
            customPositionInput.style.display = 'none';
            customPositionInput.required = false;
            customPositionInput.value = '';
        }
    }
    
    // Purpose change handler
    function handlePurposeChange() {
        const purposeSelect = document.getElementById('purpose');
        const customPurposeInput = document.getElementById('custom_purpose');
        
        if (purposeSelect.value === 'Others') {
            customPurposeInput.style.display = 'block';
            customPurposeInput.required = true;
        } else {
            customPurposeInput.style.display = 'none';
            customPurposeInput.required = false;
            customPurposeInput.value = '';
        }
    }
    
    // Office change handler
    function handleOfficeChange() {
        const officeSelect = document.getElementById('office');
        const customOfficeInput = document.getElementById('custom_office');
        
        if (officeSelect.value === 'None') {
            customOfficeInput.style.display = 'block';
        } else {
            customOfficeInput.style.display = 'none';
            customOfficeInput.value = '';
        }
    }
    
    // Signature pad functionality
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)'
    });
    
    // Load existing signature if available
    {% if entry['signature'] %}
    const img = new Image();
    img.src = '{{ entry['signature'] }}';
    img.onload = function() {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    {% endif %}
    
    // Resize canvas
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio ||1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }
    
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    
    // Clear signature
    document.getElementById('clear-signature').addEventListener('click', function() {
        signaturePad.clear();
    });
    
    // Load previous signature
    {% if entry['signature'] %}
    document.getElementById('load-signature').addEventListener('click', function() {
        const img = new Image();
        img.src = '{{ entry['signature'] }}';
        img.onload = function() {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
    });
    {% endif %}
    
    // Form validation
    document.getElementById('entry-form').addEventListener('submit', function(e) {
        if (signaturePad.isEmpty() && !document.getElementById('signature').value) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Signature Required',
                text: 'Please provide your signature before submitting.',
            });
            return false;
        }
        
        // If signature pad has content, use it; otherwise keep existing signature
        if (!signaturePad.isEmpty()) {
            document.getElementById('signature').value = signaturePad.toDataURL();
        }
    });
</script>
{% endblock %}
